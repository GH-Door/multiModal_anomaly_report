services:

  # ── PostgreSQL ──────────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: inspector
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: inspection
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U inspector -d inspection"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── FastAPI 백엔드 ───────────────────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: .env
    environment:
      DATABASE_URL: postgresql://inspector:${POSTGRES_PASSWORD:-password}@postgres:5432/inspection
      INCOMING_ROOT: /app/incoming
      OUTPUT_DIR: /app/outputs
      AD_CHECKPOINT_DIR: /app/checkpoints
      RAG_INDEX_DIR: /app/rag
      DOMAIN_RAG_PERSIST_DIR: /app/vectorstore/domain_knowledge
    ports:
      - "8000:8000"
    volumes:
      - ./checkpoints:/app/checkpoints        # PatchCore 모델 가중치
      - ./vectorstore:/app/vectorstore        # Chroma 벡터DB
      - ./rag:/app/rag                        # DINOv2 Visual RAG 인덱스
      - ./dataset:/app/dataset                # MMAD 데이터셋
      - outputs:/app/outputs                  # 히트맵, 마스크, 오버레이
      - incoming:/app/incoming                # 자동 수신 이미지
    depends_on:
      postgres:
        condition: service_healthy
    # ── GPU 설정 (Gemma3 INT4 사용 시 활성화) ──────────────────────────────
    # Gemini API만 사용한다면 아래 deploy 블록 전체를 주석 처리하세요.
    # GCP에서 GPU VM 사용 시: nvidia-container-toolkit 설치 필요
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ── React 프론트엔드 (nginx) ─────────────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - api

volumes:
  postgres_data:
  outputs:
  incoming:
